<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="orders">


    <resultMap id="ordersCustomerMap" type="Ordering">
        <association property="customer" javaType="Customer">
            <id column="cust_num" property="custNum"/>
            <result column="cust_id" property="custId"/>
            <result column="cust_passwd" property="custPasswd"/>
            <result column="cust_name" property="custName"/>
            <result column="cust_age" property="custAge"/>
            <result column="cust_phone" property="custPhone"/>
            <result column="cust_role" property="custRole"/>
        </association>

        <association property="orderDetail" javaType="OrderDetail">
            <id column="order_detail_num" property="ordersDetailNum"/>
            <result column="order_detail.order_num" property="orderNum"/>
            <result column="order_detail.movie_num" property="movieNum"/>
            <result column="movie_amount" property="movieAmount"/>
            <result column="order_detail.food_ordering_num" property="foodOrderingNum"/>
            <result column="order_detail.order_food_num" property="OrderFoodNum"/>
            <result column="set_num" property="setNum"/>
            <result column="sum_price" property="sumPrice"/>
            <result column="run_time" property="runTime"/>
            <result column="pickup_date" property="pickupDate"/>
        </association>

        <association property="movie" javaType="Movie">
            <id column="movie.movie_num" property="movieNum"/>
            <result column="movie_genre" property="movieGenre"/>
            <result column="movie_name" property="movieName"/>
            <result column="movie_director" property="movieDirector"/>
            <result column="movie_opendate" property="movieOpendate"/>
            <result column="movie_agerange" property="movieAgerange"/>
            <result column="movie_country" property="movieCountry"/>
            <result column="movie_price" property="moviePrice"/>
            <result column="movie_info" property="movieInfo"/>
        </association>

        <association property="orders" javaType="Orders">
            <id column="order_num" property="orderNum"/>
            <result column="my_cust_num" property="custNum"/>
            <result column="order_date" property="orderDate"/>
        </association>

        <collection property="orderFoodList" javaType="ArrayList" ofType="OrderFood">
            <result column="order_food.food_ordering_num" property="foodOrderingNum"/>
            <result column="order_food.order_food_num" property="orderFoodNum"/>
            <result column="food_num" property="foodNum"/>
            <result column="amount" property="amount"/>
        </collection>
    </resultMap>



    <select id="myOrders" resultMap="ordersCustomerMap">
        SELECT distinct * FROM CUSTOMER LEFT JOIN ORDERS ON (CUSTOMER.CUST_NUM = ORDERS.CUST_NUM)
        JOIN ORDER_DETAIL ON ORDERS.ORDER_NUM = ORDER_DETAIL.ORDER_NUM
        LEFT JOIN ORDER_FOOD ON ORDER_DETAIL.FOOD_ORDERING_NUM = ORDER_FOOD.FOOD_ORDERING_NUM and ORDER_DETAIL.ORDER_FOOD_NUM = ORDER_FOOD.ORDER_FOOD_NUM
        JOIN MOVIE ON (ORDER_DETAIL.MOVIE_NUM = MOVIE.MOVIE_NUM)
        WHERE Orders.CUST_NUM = #{custNum}
        ORDER BY ORDER_DETAIL.ORDER_DETAIL_NUM
    </select>

    <select id="itemAsNum" resultMap="ordersCustomerMap">
        SELECT distinct * FROM CUSTOMER LEFT JOIN ORDERS ON (CUSTOMER.CUST_NUM = ORDERS.CUST_NUM)
        JOIN ORDER_DETAIL ON ORDERS.ORDER_NUM = ORDER_DETAIL.ORDER_NUM
        LEFT JOIN ORDER_FOOD ON ORDER_DETAIL.FOOD_ORDERING_NUM = ORDER_FOOD.FOOD_ORDERING_NUM and ORDER_DETAIL.ORDER_FOOD_NUM = ORDER_FOOD.ORDER_FOOD_NUM
        JOIN MOVIE ON (ORDER_DETAIL.MOVIE_NUM = MOVIE.MOVIE_NUM)
        WHERE ORDER_DETAIL.ORDER_DETAIL_NUM = #{orderDetailNum}
    </select>




    <insert id="addOrders">
        INSERT INTO orders
        VALUES (ORDERS_SEQ.nextval, #{custNum}, SYSDATE)

        <selectKey keyProperty="orderNum" resultType="Long" order="AFTER">
            SELECT ORDERS_SEQ.currval orderNum FROM DUAL
        </selectKey>
    </insert>

    <insert id="addOrderFood">
            <selectKey keyProperty="foodOrderingNum" resultType="Long" order="BEFORE">
                SELECT FOOD_ORDERING_SEQ.nextval foodOrderingNum FROM DUAL
            </selectKey>

        <foreach collection="foodMap" index="key" item="value" separator=";" open="DECLARE BEGIN" close="; END;">
            INSERT INTO ORDER_FOOD
            VALUES (#{foodOrderingNum}, ORDERFOOD_SEQ.nextval, #{key}, #{value})
        </foreach>
    </insert>

    <insert id="addOrderDetail">
        INSERT INTO order_detail
        <if test="foodOrderingNum != null">
        VALUES (ORDER_DETAIL_SEQ.nextval, #{orderNum}, #{movieNum}, #{movieAmount}, #{foodOrderingNum}, NULL, NULL,
        #{sumPrice}, #{runTime},SYSDATE)
        </if>
        <if test="foodOrderingNum == null">
            VALUES (ORDER_DETAIL_SEQ.nextval, #{orderNum}, #{movieNum}, #{movieAmount}, NULL, NULL, NULL,
            #{sumPrice}, #{runTime},SYSDATE)
        </if>
    </insert>


    <delete id="deleteOrderDetail">
        DELETE FROM ORDER_DETAIL
        WHERE ORDER_DETAIL_NUM = #{orderDetailNum}
    </delete>

    <delete id="deleteOrderFood">
        DELETE FROM ORDER_FOOD
        WHERE FOOD_ORDERING_NUM = #{foodOrderingNum}
    </delete>

    <delete id="deleteOrders">
        DELETE FROM ORDERS
        WHERE order_num = #{orderNum}
    </delete>

</mapper>