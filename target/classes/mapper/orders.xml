<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="orders">
    <select id="list" resultType="Orders">
        SELECT * FROM orders
        WHERE cust_num = #{orders.custNum}
    </select>


    <resultMap id="orderDetailMap" type="Ordering" autoMapping="true">
        <id column="order_num" property="orderDetail.orderNum"/>

        <association property="orderDetail" column="order_num" autoMapping="true">
            <id column="order_num" property="orderNum"/>
        </association>
    </resultMap>

    <resultMap id="MovieMap" type="Ordering" extends="orderDetailMap" autoMapping="true">
        <id property="movie.movieNum" column="movie_num"/>

        <association property="movie" column="movie_num" javaType="Movie" autoMapping="true">
            <id column="movie_num" property="movieNum"/>
        </association>
    </resultMap>

    <resultMap id="ordersMap" type="Ordering" autoMapping="true">
        <id column="order_num" property="orders.orderNum"/>

        <association property="orders" column="order_num" javaType="Orders" autoMapping="true">
            <id column="order_num" property="orderNum" />
        </association>
    </resultMap>

    <resultMap id="foodOrderMap" type="OrderFood" autoMapping="true">
        <id column="food_ordering_num" property="foodOrdering"/>

        <collection property="orderDetail" column="orderFoodNum" autoMapping="true" javaType="ArrayList" ofType="OrderDetail">
            <id column="food_ordering_num" property="foodOrderingNum"/>
        </collection>
    </resultMap>


    <select id="ordering" resultMap="orderDetailMap, MovieMap, ordersMap">
        SELECT OD.ORDER_DETAIL_NUM, OD.ORDER_NUM order_num, OD.ORDER_FOOD_NUM, OD.FOOD_NUM, OD.SUM_PRICE,OD.PICKUP_DATE,
        MOVIE.MOVIE_NUM movie_num, MOVIE.MOVIE_GENRE, MOVIE.MOVIE_NAME, MOVIE.MOVIE_DIRECTOR, MOVIE.MOVIE_OPENDATE, MOVIE.MOVIE_AGERANGE,
        MOVIE.MOVIE_COUNTRY, MOVIE.MOVIE_PRICE, MOVIE.MOVIE_INFO
        FROM order_detail OD JOIN MOVIE ON (OD.MOVIE_NUM = MOVIE.MOVIE_NUM)
        WHERE OD.MOVIE_NUM = #{movie.movieNum}
    </select>



    <insert id="addOrders">
        INSERT INTO orders
        VALUES (ORDERS_SEQ.nextval, #{custNum}, SYSDATE)

        <selectKey keyProperty="orderNum" resultType="Long" order="AFTER">
            SELECT ORDERS_SEQ.currval orderNum FROM DUAL
        </selectKey>
    </insert>

    <insert id="addOrderFood">
            <selectKey keyProperty="foodOrderingNum" resultType="Long" order="BEFORE">
                SELECT FOOD_ORDERING_SEQ.nextval foodOrderingNum FROM DUAL
            </selectKey>

        <foreach collection="foodMap" index="key" item="value" separator=";" open="DECLARE BEGIN" close="; END;">
        INSERT INTO ORDER_FOOD
        VALUES (#{foodOrderingNum}, ORDERFOOD_SEQ.nextval, #{key}, #{value})
        </foreach>
    </insert>

    <insert id="addOrderDetail">
        INSERT INTO order_detail
        VALUES (ORDER_DETAIL_SEQ.nextval, #{orderNum}, #{movieNum}, #{movieAmount}, #{foodOrderingNum}, NULL, NULL,
        #{sumPrice}, SYSDATE)
    </insert>


</mapper>